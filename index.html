<!DOCTYPE html>
<html>
<head>
    <title>Clan Tactical Planner</title>
    <style>
        body { background: #0d1117; color: #c9d1d9; font-family: sans-serif; margin: 0; display: flex; }
        #sidebar { width: 250px; border-right: 1px solid #30363d; padding: 20px; height: 100vh; }
        #board { flex: 1; padding: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .slot { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 15px; }
        .badge { display: inline-block; padding: 2px 5px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-top: 5px; }
        .radar { background: #490000; color: #ff7b72; border: 1px solid #f85149; }
        .hydro { background: #002d5a; color: #a5d6ff; border: 1px solid #58a6ff; }
        select { width: 100%; margin-top: 10px; padding: 5px; background: #010409; color: white; border: 1px solid #30363d; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>Roster</h2>
    <div id="status">Syncing...</div>
    <hr style="border-color:#30363d">
    <div id="memberList"></div>
</div>

<div id="board" id="slot-container">
    <script>
        for(let i=1; i<=7; i++){
            document.write(`
                <div class="slot">
                    <small>SLOT ${i}</small>
                    <select id="p-${i}" onchange="updateShips(${i})"><option>Select Player</option></select>
                    <select id="s-${i}" onchange="showStats(${i})"><option>Select Ship</option></select>
                    <div id="stats-${i}" style="margin-top:10px; font-size:12px;"></div>
                </div>
            `);
        }
    </script>
</div>

<script>
    let db = {};
    // PASTE YOUR WORKING URL HERE
    const API_URL = 'https://script.google.com/macros/s/AKfycbw-VW-dgBwLQ1LUUT35OU38melYwWTATGAZ32Q-WhOxgPVIsiCqNnA92NrV_f0qDdz_MQ/exec';

    async function load() {
        const statusDiv = document.getElementById('status');
        try {
            statusDiv.innerHTML = "Connecting to Fleet Command...";
            
            // This setup is the "Magic Key" for Google Apps Script + GitHub
            const response = await fetch(API_URL, {
                method: 'GET',
                mode: 'cors',
                redirect: 'follow'
            });

            if (!response.ok) throw new Error('Network response was not ok');

            const rawData = await response.json();
            
            if (rawData.error) {
                statusDiv.innerHTML = "Sheet Error: " + rawData.error;
                return;
            }

            // Process the data since we simplified the doGet
            db.players = rawData.players.slice(1); // Remove headers
            db.library = {};
            
            // Convert raw library rows into a searchable map
            rawData.libraryRaw.slice(1).forEach(row => {
                db.library[row[0]] = {
                    tier: row[1], class: row[2], detect: row[3],
                    guns: row[4], torps: row[5], radar: row[6],
                    hydro: row[7], speed: row[8]
                };
            });

            db.lastUpdated = rawData.lastUpdated;
            statusDiv.innerHTML = "Online - Last Sync: " + db.lastUpdated;
            
            renderUI(); 
            
        } catch (e) {
            console.error("Critical Error:", e);
            statusDiv.innerHTML = "<b>Connection Failed.</b><br><small>Try opening in Incognito mode.</small>";
        }
    }

    function renderUI() {
        const names = [...new Set(db.players.map(p => p[0]))].sort();
        
        // Fill Player Selects
        document.querySelectorAll('[id^="p-"]').forEach(sel => {
            sel.innerHTML = '<option>Select Player</option>';
            names.forEach(n => sel.add(new Option(n, n)));
        });

        // Fill Sidebar
        document.getElementById('memberList').innerHTML = names.join('<br>');
    }

    function updateShips(id) {
        const name = document.getElementById(`p-${id}`).value;
        const shipSel = document.getElementById(`s-${id}`);
        shipSel.innerHTML = '<option>Select Ship</option>';
        
        // Filter players data for selected name
        db.players.filter(p => p[0] === name).forEach(p => {
            shipSel.add(new Option(`${p[1]} (${p[3]}% WR)`, p[1]));
        });
    }

    function showStats(id) {
        const shipName = document.getElementById(`s-${id}`).value;
        const info = db.library[shipName];
        const display = document.getElementById(`stats-${id}`);
        
        if(info) {
            display.innerHTML = `
                <div style="margin-bottom:5px">Detect: <b>${info.detect}km</b> | Speed: <b>${info.speed}kn</b></div>
                ${info.radar && info.radar !== "No" ? `<span class="badge radar">RADAR ${info.radar}km</span>` : ''}
                ${info.hydro && info.hydro !== "No" ? `<span class="badge hydro">HYDRO ${info.hydro}km</span>` : ''}
            `;
        } else {
            display.innerHTML = "";
        }
    }

    // Start the app
    load();
</script>
</body>
</html>






