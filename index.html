<!DOCTYPE html>
<html>
<head>
    <title>Clan Tactical Planner</title>
    <style>
        body { background: #0d1117; color: #c9d1d9; font-family: sans-serif; margin: 0; display: flex; }
        #sidebar { width: 250px; border-right: 1px solid #30363d; padding: 20px; height: 100vh; }
        #board { flex: 1; padding: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .slot { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 15px; }
        .badge { display: inline-block; padding: 2px 5px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-top: 5px; }
        .radar { background: #490000; color: #ff7b72; border: 1px solid #f85149; }
        .hydro { background: #002d5a; color: #a5d6ff; border: 1px solid #58a6ff; }
        select { width: 100%; margin-top: 10px; padding: 5px; background: #010409; color: white; border: 1px solid #30363d; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>Roster</h2>
    <div id="status">Syncing...</div>
    <hr style="border-color:#30363d">
    <div id="memberList"></div>
</div>

<div id="board" id="slot-container">
    <script>
        for(let i=1; i<=7; i++){
            document.write(`
                <div class="slot">
                    <small>SLOT ${i}</small>
                    <select id="p-${i}" onchange="updateShips(${i})"><option>Select Player</option></select>
                    <select id="s-${i}" onchange="showStats(${i})"><option>Select Ship</option></select>
                    <div id="stats-${i}" style="margin-top:10px; font-size:12px;"></div>
                </div>
            `);
        }
    </script>
</div>

<script>
    let db = {};
    const API_URL = 'https://script.google.com/macros/s/AKfycbwaqvaQziBa6uBn5WoIjK4t9a-5IqDpBfnmGt1rXh1AuycKfoNNMo6j7Qz5lLANvBd09Q/exec';

async function load() {
    // 1. DOUBLE CHECK: Make sure this URL ends in /exec
    const API_URL = 'https://script.google.com/macros/s/AKfycbwaqvaQziBa6uBn5WoIjK4t9a-5IqDpBfnmGt1rXh1AuycKfoNNMo6j7Qz5lLANvBd09Q/exec';
    const statusDiv = document.getElementById('status');
    
    try {
        statusDiv.innerHTML = "Fetching data...";
        
        // This specific configuration is required for Google Apps Script
        const response = await fetch(API_URL, {
            method: 'GET',
            mode: 'cors', // Ensure CORS mode is on
            redirect: 'follow' // Google ALWAYS redirects Web Apps
        });

        if (!response.ok) throw new Error('Network response was not ok');

        const db = await response.json();
        
        if (db.error) {
            statusDiv.innerHTML = "Sheet Error: " + db.error;
            return;
        }

        // Save to global variable
        window.db = db;
        statusDiv.innerHTML = "Last Sync: " + db.lastUpdated;
        renderUI(); 
        
    } catch (e) {
        console.error("Fetch error details:", e);
        statusDiv.innerHTML = "Connection Failed. Check URL permissions.";
    }
}

    function updateShips(id) {
        const name = document.getElementById(`p-${id}`).value;
        const shipSel = document.getElementById(`s-${id}`);
        shipSel.innerHTML = '<option>Select Ship</option>';
        db.players.filter(p => p[0] === name).forEach(p => {
            shipSel.add(new Option(`${p[1]} (${p[3]}% WR)`, p[1]));
        });
    }

    function showStats(id) {
        const ship = document.getElementById(`s-${id}`).value;
        const info = db.library[ship];
        const display = document.getElementById(`stats-${id}`);
        if(info) {
            display.innerHTML = `
                Detect: <b>${info.detect}km</b> | Speed: <b>${info.speed}kn</b><br>
                ${info.radar !== "No" ? `<span class="badge radar">RADAR ${info.radar}</span>` : ''}
                ${info.hydro !== "No" ? `<span class="badge hydro">HYDRO ${info.hydro}</span>` : ''}
            `;
        }
    }

    load();
</script>
</body>
</html>




